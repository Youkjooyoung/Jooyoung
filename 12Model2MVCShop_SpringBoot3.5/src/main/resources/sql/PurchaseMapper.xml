<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.model2.mvc.service.purchase.PurchaseDao">

	<resultMap id="purchase"
		type="com.model2.mvc.service.domain.Purchase">
		<id property="tranNo" column="TRAN_NO" />
		<result property="paymentOption" column="PAYMENT_OPTION" />
		<result property="paymentAmount" column="PAYMENT_AMOUNT" />
		<result property="receiverName" column="RECEIVER_NAME" />
		<result property="receiverPhone" column="RECEIVER_PHONE" />
		<result property="divyAddr" column="DIVY_ADDR" />
		<result property="divyDate" column="DLVY_DATE" />
		<result property="divyRequest" column="DLVY_REQUEST" />
		<result property="orderDate" column="ORDER_DATE" />
		<result property="tranCode" column="TRAN_STATUS_CODE" />
		<result property="qty" column="QTY" />
		<result property="cancelDate" column="CANCEL_DATE" />
		<result property="cancelUser" column="CANCEL_USER" />
		<result property="cancelReason" column="CANCEL_REASON" />
		<result property="zipcode" column="ZIPCODE" />
		<result property="addrDetail" column="ADDR_DETAIL" />

		<association property="buyer"
			javaType="com.model2.mvc.service.domain.User" column="BUYER_ID"
			select="com.model2.mvc.service.user.UserDao.getUser" />

		<association property="purchaseProd"
			javaType="com.model2.mvc.service.domain.Product" column="PROD_NO"
			select="com.model2.mvc.service.product.ProductDao.getProduct" />
	</resultMap>

	<!-- 등록 -->
	<insert id="addPurchase"
	parameterType="com.model2.mvc.service.domain.Purchase">
	<selectKey keyProperty="tranNo" resultType="int"
		order="BEFORE">
		SELECT SEQ_TRANSACTION_TRAN_NO.NEXTVAL FROM DUAL
	</selectKey>

	INSERT INTO TRANSACTION (
	TRAN_NO, BUYER_ID, PROD_NO, PAYMENT_OPTION,
	RECEIVER_NAME, RECEIVER_PHONE, DIVY_ADDR,
	DLVY_DATE, DLVY_REQUEST,
	ORDER_DATE,
	TRAN_STATUS_CODE, QTY, ZIPCODE,
	ADDR_DETAIL, PAYMENT_AMOUNT
	)
	VALUES (
	#{tranNo},
	#{buyer.userId},
	#{purchaseProd.prodNo},
	#{paymentOption, jdbcType=VARCHAR},
	#{receiverName, jdbcType=VARCHAR},
	#{receiverPhone, jdbcType=VARCHAR},
	#{divyAddr, jdbcType=VARCHAR},
	TO_DATE(#{divyDate, jdbcType=VARCHAR}, 'YYYY-MM-DD'),
	#{divyRequest,
	jdbcType=VARCHAR},
	SYSDATE,
	#{tranCode, jdbcType=VARCHAR},
	#{qty,
	jdbcType=NUMERIC},
	#{zipcode, jdbcType=VARCHAR},
	#{addrDetail,
	jdbcType=VARCHAR},
	#{paymentAmount, jdbcType=NUMERIC}
	)
	</insert>

	<!-- 단건 -->
	<select id="getPurchase" parameterType="int"
		resultMap="purchase">
		SELECT t.* FROM TRANSACTION t WHERE t.TRAN_NO = #{tranNo}
	</select>

	<!-- 내 구매 목록(페이징) -->
	<select id="getPurchaseList" parameterType="map"
		resultMap="purchase">
		SELECT * FROM (
		SELECT ROWNUM rnum, A.* FROM (
		SELECT t.* FROM TRANSACTION t
		WHERE t.BUYER_ID = #{buyerId}
		<if
			test="search != null and search.searchKeyword != null and search.searchKeyword != ''">
			AND (t.RECEIVER_NAME LIKE '%'||#{search.searchKeyword}||'%'
			OR t.DIVY_ADDR LIKE '%'||#{search.searchKeyword}||'%')
		</if>
		ORDER BY t.TRAN_NO DESC
		) A
		WHERE ROWNUM &lt;= #{search.endRowNum}
		)
		WHERE rnum &gt;= #{search.startRowNum}
	</select>

	<select id="getTotalCountPurchase" parameterType="map"
		resultType="int">
		SELECT COUNT(*) FROM TRANSACTION t
		WHERE t.BUYER_ID = #{buyerId}
		<if
			test="search != null and search.searchKeyword != null and search.searchKeyword != ''">
			AND (t.RECEIVER_NAME LIKE '%'||#{search.searchKeyword}||'%'
			OR t.DIVY_ADDR LIKE '%'||#{search.searchKeyword}||'%')
		</if>
	</select>

	<!-- 판매 목록(관리자) -->
	<select id="getSaleList"
		parameterType="com.model2.mvc.common.Search" resultMap="purchase">
		SELECT * FROM (
		SELECT ROWNUM rnum, A.* FROM (
		SELECT t.* FROM TRANSACTION t
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE (t.BUYER_ID LIKE '%'||#{searchKeyword}||'%'
			OR t.RECEIVER_NAME LIKE '%'||#{searchKeyword}||'%')
		</if>
		ORDER BY t.TRAN_NO DESC
		) A
		WHERE ROWNUM &lt;= #{endRowNum}
		)
		WHERE rnum &gt;= #{startRowNum}
	</select>

	<select id="getTotalCountSale"
		parameterType="com.model2.mvc.common.Search" resultType="int">
		SELECT COUNT(*) FROM TRANSACTION t
		<if test="searchKeyword != null and searchKeyword != ''">
			WHERE (t.BUYER_ID LIKE '%'||#{searchKeyword}||'%'
			OR t.RECEIVER_NAME LIKE '%'||#{searchKeyword}||'%')
		</if>
	</select>

	<!-- 수정 -->
	<update id="updatePurchase"
		parameterType="com.model2.mvc.service.domain.Purchase">
		UPDATE TRANSACTION
		<trim prefix="SET" suffixOverrides=",">
			<if test="paymentOption != null"> PAYMENT_OPTION = #{paymentOption}, </if>
			<if test="receiverName != null"> RECEIVER_NAME = #{receiverName}, </if>
			<if test="receiverPhone != null"> RECEIVER_PHONE = #{receiverPhone}, </if>
			<if test="divyAddr != null"> DIVY_ADDR = #{divyAddr}, </if>
			<if test="divyDate != null">
				DLVY_DATE = TO_DATE(#{divyDate, jdbcType=VARCHAR}, 'YYYY-MM-DD'),
			</if>
			<if test="divyRequest != null">
				DLVY_REQUEST = #{divyRequest, jdbcType=VARCHAR},
			</if>
			<if test="zipcode != null"> ZIPCODE = #{zipcode}, </if>
			<if test="addrDetail != null"> ADDR_DETAIL = #{addrDetail}, </if>
			<if test="paymentAmount != null"> PAYMENT_AMOUNT = #{paymentAmount}, </if>
		</trim>
		WHERE TRAN_NO = #{tranNo}
	</update>


	<!-- 상태코드 변경(거래번호) -->
	<update id="updateTranCode" parameterType="map">
		UPDATE TRANSACTION
		SET TRAN_STATUS_CODE = #{tranCode}
		WHERE TRAN_NO = #{tranNo}
	</update>

	<!-- 상태코드 변경(상품번호 기준: 활성건 최신 위주로 일괄) -->
	<update id="updateTranCodeByProd" parameterType="map">
		UPDATE TRANSACTION
		SET TRAN_STATUS_CODE = #{tranCode}
		WHERE PROD_NO = #{prodNo}
		AND TRAN_STATUS_CODE IN ('001','002','003','004')
	</update>

	<!-- 단일 상품 최신 상태코드 -->
	<select id="getLatestTranCodeByProd" parameterType="int"
		resultType="string">
		SELECT TRAN_STATUS_CODE
		FROM (
		SELECT TRAN_STATUS_CODE
		FROM TRANSACTION
		WHERE PROD_NO = #{prodNo}
		ORDER BY TRAN_NO DESC
		)
		WHERE ROWNUM = 1
	</select>

	<!-- 여러 상품 최신 상태코드 -->
	<select id="getLatestTranCodeByProdNos" parameterType="list"
		resultType="map">
		SELECT x.PROD_NO AS prodNo, x.TRAN_STATUS_CODE AS tranCode
		FROM (
		SELECT t.PROD_NO, t.TRAN_STATUS_CODE,
		ROW_NUMBER() OVER (PARTITION BY t.PROD_NO ORDER BY t.TRAN_NO DESC) AS rn
		FROM TRANSACTION t
		WHERE t.PROD_NO IN
		<foreach collection="list" item="value" open="(" separator=","
			close=")">
			#{value}
		</foreach>
		) x
		WHERE x.rn = 1
	</select>

	<!-- 최신 구매정보(여러 상품) -->
	<select id="getLatestPurchaseInfoByProdNos" parameterType="list"
		resultType="map">
		SELECT PROD_NO AS prodNo, TRAN_STATUS_CODE AS tranCode, ORDER_DATE AS
		orderDate, QTY AS qty
		FROM (
		SELECT t.*,
		ROW_NUMBER() OVER (PARTITION BY t.PROD_NO ORDER BY t.TRAN_NO DESC) rn
		FROM TRANSACTION t
		WHERE t.PROD_NO IN
		<foreach collection="list" item="value" open="(" separator=","
			close=")">
			#{value}
		</foreach>
		)
		WHERE rn = 1
	</select>

	<!-- 특정 상품의 구매 이력 -->
	<select id="getPurchaseHistoryByProduct" parameterType="int"
		resultMap="purchase">
		SELECT t.*
		FROM TRANSACTION t
		WHERE t.PROD_NO = #{prodNo}
		ORDER BY t.TRAN_NO DESC
	</select>

	<!-- 활성(001~004) 최신 상태코드 -->
	<select id="getLatestActiveTranCodeByProdNos"
		parameterType="list" resultType="map">
		SELECT prodNo, tranCode FROM (
		SELECT t.PROD_NO AS prodNo, t.TRAN_STATUS_CODE AS tranCode,
		ROW_NUMBER() OVER (PARTITION BY t.PROD_NO ORDER BY t.TRAN_NO DESC) rn
		FROM TRANSACTION t
		WHERE t.TRAN_STATUS_CODE IN ('001','002','003','004')
		AND t.PROD_NO IN
		<foreach collection="list" item="value" open="(" separator=","
			close=")">
			#{value}
		</foreach>
		) WHERE rn = 1
	</select>

	<!-- 취소 사유 기록 -->
	<update id="updateCancelInfo" parameterType="map">
		UPDATE TRANSACTION
		SET CANCEL_REASON = #{reason},
		CANCEL_DATE = SYSDATE
		WHERE TRAN_NO = #{tranNo}
	</update>

</mapper>
